<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCM Dashboard - Runtime Context Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .flow-card { transition: all 0.3s ease; }
        .flow-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .session-card { transition: all 0.2s ease; cursor: pointer; }
        .session-card:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold">RCM Dashboard</h1>
            <p class="text-blue-100 text-sm mt-1">Runtime Context Management - Knowledge Flow Visualization</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Hypothesis -->
            <div class="flow-card bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500 cursor-pointer" onclick="loadSessions('hypothesis')">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Hypothesis</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="count-hypothesis">-</p>
                        <p class="text-gray-500 text-xs mt-1">Auto-imported, untagged</p>
                    </div>
                    <div class="bg-yellow-100 rounded-full p-3">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Codified -->
            <div class="flow-card bg-white rounded-lg shadow p-6 border-l-4 border-blue-500 cursor-pointer" onclick="loadSessions('codified')">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Codified</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="count-codified">-</p>
                        <p class="text-gray-500 text-xs mt-1">Tagged, structured</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-3">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Validated -->
            <div class="flow-card bg-white rounded-lg shadow p-6 border-l-4 border-green-500 cursor-pointer" onclick="loadSessions('validated')">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Validated</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="count-validated">-</p>
                        <p class="text-gray-500 text-xs mt-1">Quality-checked</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-3">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Promoted -->
            <div class="flow-card bg-white rounded-lg shadow p-6 border-l-4 border-purple-500 cursor-pointer" onclick="loadSessions('promoted')">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Promoted</p>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="count-promoted">-</p>
                        <p class="text-gray-500 text-xs mt-1">RAG-indexed</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-3">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search sessions..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        onkeyup="handleSearch()"
                    >
                </div>
                <button onclick="loadStats()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Sessions List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    Sessions: <span id="current-state-label">All</span>
                </h2>
            </div>
            <div id="sessions-container" class="divide-y divide-gray-200">
                <!-- Sessions will be loaded here -->
                <div class="px-6 py-12 text-center text-gray-500">
                    Loading sessions...
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = '';

        let currentState = null;
        let allSessions = [];

        // Load stats
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const stats = await res.json();

                document.getElementById('count-hypothesis').textContent = stats.hypothesis;
                document.getElementById('count-codified').textContent = stats.codified;
                document.getElementById('count-validated').textContent = stats.validated;
                document.getElementById('count-promoted').textContent = stats.promoted;
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        // Load sessions by state
        async function loadSessions(state = null) {
            currentState = state;
            document.getElementById('current-state-label').textContent =
                state ? state.charAt(0).toUpperCase() + state.slice(1) : 'All';

            try {
                const url = state ? `${API_BASE}/api/sessions/${state}` : `${API_BASE}/api/sessions`;
                const res = await fetch(url);
                const data = await res.json();

                allSessions = state ? data : Object.values(data).flat();
                renderSessions(allSessions);
            } catch (err) {
                console.error('Error loading sessions:', err);
            }
        }

        // Render sessions
        function renderSessions(sessions) {
            const container = document.getElementById('sessions-container');

            if (sessions.length === 0) {
                container.innerHTML = '<div class="px-6 py-12 text-center text-gray-500">No sessions found.</div>';
                return;
            }

            container.innerHTML = sessions.map(s => `
                <div class="session-card px-6 py-4" onclick="viewSession('${s.shortId}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(s.title)}</h3>
                            <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                    </svg>
                                    ${s.messageCount} messages
                                </span>
                                <span>${(s.size / 1024).toFixed(1)} KB</span>
                                <span class="px-2 py-1 rounded text-xs font-medium bg-gray-100">${s.platform}</span>
                                <span class="px-2 py-1 rounded text-xs font-medium ${getStateColor(s.flowState)}">${s.flowState}</span>
                            </div>
                            ${s.tags.length > 0 ? `
                                <div class="mt-2 flex flex-wrap gap-2">
                                    ${s.tags.map(tag => `<span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs">${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="text-right text-sm text-gray-500">
                            <div>${new Date(s.modified).toLocaleDateString()}</div>
                            <div class="text-xs">${new Date(s.modified).toLocaleTimeString()}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // View session details
        function viewSession(id) {
            window.open(`/session.html?id=${id}`, '_blank');
        }

        // Handle search
        function handleSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();

            if (!query) {
                renderSessions(allSessions);
                return;
            }

            const filtered = allSessions.filter(s =>
                s.title.toLowerCase().includes(query) ||
                s.tags.some(t => t.toLowerCase().includes(query)) ||
                s.shortId.toLowerCase().includes(query)
            );

            renderSessions(filtered);
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getStateColor(state) {
            const colors = {
                hypothesis: 'bg-yellow-100 text-yellow-800',
                codified: 'bg-blue-100 text-blue-800',
                validated: 'bg-green-100 text-green-800',
                promoted: 'bg-purple-100 text-purple-800',
            };
            return colors[state] || 'bg-gray-100 text-gray-800';
        }

        // Initial load
        loadStats();
        loadSessions();

        // Refresh every 30 seconds
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
